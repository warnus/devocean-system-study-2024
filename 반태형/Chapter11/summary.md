# 뉴스 피드 시스템 설계
* 뉴스피드란 홈 페이지 중앙에서 지속적으로 업데이트 되는 스토리들로 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동, 좋아요 등을 포함한다.

## 1단계 문제 이해 및 설계 범위 확정
* 5000명의 친구를 갖는다
* 뉴스피드 포스트는 시간 흐름 역순으로 표시된다
* 매일 천만명 방문

## 2단계 개략적 설계안 제시 및 동의 구하기
* 피드발행
* 뉴스피드 발행

### 뉴스피드 api
* 클라이언트 - 서버 통신
* 상태 업데이트, 뉴스피드를 가져오거나 친구 추가 등
    * 피드발행 api
        * 사용자가 피드를 올리면
            * 포스팅 저장 서비스
            * 포스팅 전송 서비스
            * 알림 서비스
    * 피드 읽기 api
        * 뉴스 피드를 읽는다.
        * 캐시에서 가져온다
        * 피드를 렌더링할 때 필요한 피드 ID 를 보관한다

## 3단계 상세 걸계
* 피드발행 흐름 상세 설계
    * 웹 서버
        * 클라이언트 통신 및 인증, 처리율 제한기
    * 포스트 전송 서비스(팬아웃)
        * 사용자의 친구에게 사용자의 새로운 피드를 전달
        * 쓰기 시점에 팬아웃하거나(push, fanout-on-write), 읽기 시점에 팬아웃을 할 수 있다(pull, fanout-on-read)
            * fanout-on-write
                * 장점
                    * 뉴스피드가 실시간으로갱신, 즉시 전송
                    * 새 포스팅이 기록되는 순간 뉴스 피드가 갱신되므로 뉴스피드를 읽는데 시간이 짧아진다
                * 단점
                    * 친구목록을 갖고오고 그 목록의 사용자의 모든 피드를 업데이트하는 것은 많은 시간이 소요될 수 있다.
                    * 서비스를 자주 사용하지 않는 사용자도 갱신해야 한다.
            * fanout-on-read
                * 장점
                    * 비활성화된 사용자, 거의 사용하지 않는 사용자가 많다면 이 모델이 좋다
                    * 데이터를 각 친구에게 푸시하지 않으므로 핫키문제도 없다.
                * 단점
                    * 뉴스피드를 읽는데 많은 시간이 소요될 수 있다.
            * 적절히 섞을 수 있다.
                * 대부분의 사용자에게는 푸시모델을 사용하되 친구나 팔로워가 많다면 그 경우에는 풀 모델을 사용한다.
                * 그래프 디비에서 친구목록 ID 를 가져온다.
                * 사용자 정보 캐시에서 친구 정보를 가져오고 일부 친구를 걸러낸다.
                * 친구목록과 새 포스트ID 를 메시지 큐에 넣는다.
                * 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내서 뉴시피드 캐시에 넣는다.
        * 피드 읽기 흐름 상세 설계
            * 이미지 비디오 등은 CDN 을 활용
            * 사용자가 뉴스 피드를 읽으려는 요청을 보낸다.
            * 웹 서버는 피드를 가져오는 뉴스 피드 서비스를 호출한다
            * 뉴스 피드 서비스는 캐시에서 포스팅 ID 목록을 가져온다
            * 뉴스 피드에 표시할 사용자 이름, 사용자 사진, 포스팅 컨텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 가져와서 완전한 뉴스 피드를 만든다.
            * JSON 으로 클라이언트에게 전달한다.
        * 캐시 구조
            * 뉴스피드 - 뉴스피드
            * 콘텐츠 - 인기콘텐츠, 일반 콘텐츠
            * 소셜 그래프 - 팔로워, 팔로잉
            * 행동 - 좋아요, 답글, 기타
            * 횟수 - 좋아요 횟수, 답글 횟수, 기타

* ## 4단계 마무리
* 데이터베이스 규모 확장
    * 수직적 규모 확장 vs 수평적 규모 확장
    * sql vs nosql
    * master-slave 다중화
    * 복제본 읽기
    * 일관성 모델
    * 샤딩
* 웹 계층을 무상태로 운영하기
* 최대한 많은 데이터 캐시
* 여러 데이터 센터 지원
* 메시지큐를 이용한 컴포넌트 사이의 결합도 낮추기
* 핵심 메트릭 모니터링, QPS, 새로고침 지연시간
