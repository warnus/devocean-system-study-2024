# 알림 시스템 설계
* 알림 시스템
  * 모바일 푸시알림
  * SMS 메시지
  * 이메일
  * 카카오톡

## 1단계 문제 이해 및 설계 범위 확정
* soft real time system
  * 하드리얼타임 - 허용지연 거의 없음
  * 소프트 리얼타임 - 수밀리초 ~수초 정도의 지연정도
  * 니어 리얼타임 - 수초~수분의 지연정도
* 푸시알림, SMS, 이메일 지원
  * ios, android, desktop
* 알람을 보내는 주체는 애플리케이션 혹은 서버 스케쥴링
* 알림을 받지 않도록 설정 가능해야함
* 천만건의 모바일 푸시알림, 백만건의 SMS 메시지, 5백만 건의 이메일

## 2단계 개략적 설계안 제시 및 동의 구하기

### ios
* 알림제공자 - APNS - ios 단말
* 알림제공자: 알림요청을 만들어서 APNS 로 보낸다
* APNS: Apple Push Notification Server, 애플이 제공하는 원격 서비스로 푸시 알림을 ios 장치로 보낸다

### Android
* 알림제공자 - FCM - 안드로이드 단말
* FCM(Firebase Cloud Messaging)

### SMS
* 알림 제공자 -> SMS 서비스 - SMS 수신단말

### 이메일
* 알림제공자 -> 이메일 서비스 -> 이메일 수신
* 대부분의 회사는 고유 이메일 서버를 구축할 역량은 있지만 상용 이메일 서비스를 이용하기도 한다. 전송 성공률도 높고 데이터 분석 기능도 제공한다.

### 연락처 수집 절차
* 알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등이 필요하다
* 이 때, 한 명의 유저는 여러개의 단말을 가질 수 있기 때문에 별도로 User, Device 를 나눈다

### 개선
* 여러 서비스 -> 하나의 알림 시스템(+3자 제공 서비스) -> 사용자 단말
의 구조라면 SPOF 가 생긴다.
* 글로벌이라면 FCM 을 이용할 수 없는 경우에 대한 처리가 필요하다.
* 알림 서버는 다음 기능을 제공한다.
  * 알림 전송 api: 인증된 클라이언트만 이용 가능
  * 알림 검증 : 이메일주소, 전화번호 등에 대한 기본 검증
  * 데이터베이스/캐시 질의
* 알림 시스템과 별개로 ios, android, sms, 이메일 등 각각의 메시지 큐를 두고 작업 서버를 따로 둔다.
  * 큐에 담겨있기 때문에 재처리가 쉽고 병렬적으로 처리가 가능하다.
  * ios가 실패해도 안드로이드는 성공 가능하다.
* 알림시스템이 캐시/데이터베이스를 갖도록 하여 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.

## 3단계 상세 설계
* 안정성
* 전송률 제한, 재시도 메커니즘, 보안, 등 모니터링과 이벤트 추적

### 안정성
* 어떤 경우에도 알람이 소실되면 안된다. 순서는 달라도 상관없지만 사라지면 곤란하다. 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.
* 알림 로그 데이터 베이스를 유지하는 것이 한 가지 방법이다.
* 중복전송 방지
  * 같은 알림이 여러번 반복되는 것을 완전히 막는 것은 불가능하다. 분산 시스템 특성상 가끔은 같은 알림이 중복되어 전송되기도 한다.
  * 빈도를 줄이려면 간단하게는 이벤트 ID 를 검사하여 처리된적이 없는 경우만 알림을 발송한다.

## 추가로 필요한 컴포넌트 및 고려사항
* 알림템플릿
  * 본문, 타이틀 등을 템플릿으로 미리 만들어둔다.
* 알림 설정
  * 알람 설정이 켜진 경우에만 해당 알람을 보내도록 해야한다.
* 이벤트 추적
  * 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 등의 데이터 분석
* 시스템 모니터링
  * 큐 모니터링
* 처리율 제한기
  * 사용자에게 너무 많은 알림을 보내지 않게 적절히 빈도수를 조절해야 한다.

## 4단계 마무리
* 안정성
* 보안
* 이벤트 추적 및 모니터링
* 사용자 설정
* 전송률 제한
