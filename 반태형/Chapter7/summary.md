# 분산 시스템을 위한 유일 ID 생성기 설계

## 문제이해 및 설계 범위 확정
* 초당 10000개 생성
* 유일함
* 64비트
* 정렬 가능
* 숫자로만 구성

## 대략적 설계안 제시 및 동의 구하기
* MMR(multi master replication)
    * auto increment를 1이 아닌 k(데이터베이스 수) 씩 증가
    * 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다
    * 유일성은 보장되지만 시간 흐름에 맞추어 커지는 것은 보장할 수 없다.
    * 서버 추가 / 삭제에도 잘 동작하도록 만들기 어렵다
* UUID
    * 이론적으로는 중복 가능
    * 서버 사이의 조율이 필요없다
    * 규모 확장도 쉽다
    * 128비트로 길다
    * 시간순 정렬이 안된다
    * 숫자가 아닌 값이 포함된다
* 티켓 서버
    * 플리커는 분산 기본키를 만들기 위해 이 기술을 이용
    * 유일성이 보장되는 숫자로만 구성된 아이디를 쉽게 만들 수 있다
    * 중소 규모에 적합하다.
    * SPOF가 될 수 있다. 여러대를 사용하면 데이터 동기화가 문제가 된다
* 트위터 스노우플레이크
    * 부호 + 타임스탬프 + 데이터센터 식별자 + 서버 식별자 + 일련번호
    * 데이터 센터와 서버는 시스템이 시작될때 결정되며 운영중엔 변경되지 않는다.
    * 대신 변경할 때 기존 데이터 마이그레이션이 필요하다
    * 타임스탬프와 일련번호는 생성기가 도는 중 만들어진다
    * 타임스탬프에 41비트를 사용하면 약 69년의 데이터를 표현한다.
    * 일련번호는 12비트이므로 4096개를 갖는다. 즉 동시에 4096개가 넘어가면 유일하지 않을 수도 있다.

## 마무리
* 시계 동기화
    * ID 생성 서버들이 전부 같은 시계를 사용한다고 가정하였다. 하나의 서버가 여러 코어에서 실행된다면 유효하지 않을 수도 있다.
    * NTP(network time protocol) 이 있다
    * 동시성이 낮다면 타임스탬프를 늘리고 일련번호를 줄일수도 있다.
    * 고가용성은 필수이다.


## 참고
* 데이터베이스 샤딩을 하면 하나의 디비에서는 유니크하지만 여러대의 서버에 걸쳐서 유일함을 보장하진 않는다.
* 생성 프로세스가 하나일 때만 유일성이 보장이 된다. Worker Id 를 추가할 수도 있다.
    * 스레드마다 워커아이디가 되야할 수도 있다.
    * https://blog.x.com/engineering/en_us/a/2010/announcing-snowflake#:~:text=and%20sequence%20number.-,Sequence,-numbers%20are%20per
* 몽고디비
    * 타임스탬프 4바이트
    * 머신아이디 3바이트
    * 프로세스아이디 2바이트
    * 카운터 3바이트
  
