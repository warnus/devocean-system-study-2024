# 알림 시스템 설계

## 1단계: 문제 이해 및 설계 범위 확정
하루에 백만 건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는 게 쉬운 과제는 아니다. 보통 정해진 정답이 없으므로 요구사항이 무엇인지 파악하자.

- Push 알림 / SMS / 이메일 모두 지원
- 연성 실시간(soft real-time) 시스템. 가능한 빨리 알림이 전달되야 하지만, 약간의 지연은 허용
- iOS / Android, laptob/desktop을 지원
- 알람은 클라이언트 애플리케이션 프로그램이 만들며, 서버 측에서 스케줄링 할 수 있음.
- 알림을 받지 않도록(opt-out)설정할 수 있어야 함.
- 하루에 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 함

## 2단계: 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

#### iOS 푸시 알림
iOS에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.

- 알림 제공자(provider): 알림 요청을 만들어 애플 푸시 알림 서비스 (APNS)로 보내는 주체. 다음과 같은 데이터가 필요하다.
  - 단말 토큰: 알림 요청을 보내기 위한 고유 식별자
  - 페이로드: 알림 내용을 담은 JSON Dictionary
- APNS: 애플이 제공하는 원격 서비스. 푸시 알림을 iOS 장치로 보내는 역할
- iOS 단말: 푸시 알림을 수신하는 사용자 단말

#### 안드로이드 푸시 알림
안드로이드도 비슷한 절차로 전송되며, APNS 대신 FCM을 사용한다.

#### SMS 메시지
SMS 서비스는 제3사업자의 서비스를 많이 이용하며, 대부분 상용 서비스라 이용요금을 내야한다.

#### 이메일
대부분의 회사는 고유 이메일 서버를 구축할 역량을 갖추고 있지만, 상용 이메일 서버를 이용한다.

### 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 사용자가 우리 앱을 설치하거나 계정을 등록하면 API 서버는 사용자의 정보를 수집하여 DB에 저장한다.

### 알림 전송 및 수신 절차

#### 개략적 설계안 (초안)
![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F0fe4b55c-95b4-4dda-a0b6-93aad792aa01%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-9.png%3Ftable%3Dblock%26id%3D538652dd-87de-4e86-9c97-43a2a866f7d3%26cache%3Dv2&w=2048&q=75)

이 설계에는 몇가지 문제가 있다.
- SPOF: 알림 서비스에 서버가 하나밖에 없어서, 장애 발생시 전체 서비스 장애로 이어진다.
- 규모 확장성: 한 대 서비스로 푸시 알림에 관해 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 늘릴 수 없다.
- 성능 병목: 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다. 사용자 트래픽이 몰릴 경우 시스템이 과부하 상태로 빠질 수 있다.

#### 개략적 설계안 (개선된 버전)
다음과 같은 방향으로 개선해보자.
- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F0aa9f952-3d65-4e87-8107-994d139c5207%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-10.png%3Ftable%3Dblock%26id%3D64b05f43-fc31-4cea-acec-b255eefcb96d%26cache%3Dv2&w=2048&q=75)

### 3단계: 상세 설계

#### 안정성
분산 환경에서 안정성을 확보하기 위해선 몇가지를 고려해야 한다.

- 데이터 손실 방지: 알림이 지연되거나 순서가 달라져도 괜찮지만, 알림이 손실되면 안된다. 이 요구사항을 만족하려면 알림 시스템은 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 한다. 

- 알림 중복 전송 방지: 분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송되기도 한다. 그 빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고, 오류를 신중하게 처리해야 한다. 

#### 추가로 필요한 컴포넌트 및 고려사항
- 알림 템플릿: 알림 메시지의 대부분은 형식이 비슷하다. 알림 템플릿을 통해 알림 메시지를 항상 다시 만들 필요 없도록 해준다. (ex. [item_name]이 다시 입고 되었습니다! [date]까지만 주문 가능합니다!)

- 알림 설정: 사용자가 이미 너무 많은 알림을 받고 있어서 쉽게 피곤함을 느낀다. 따라서 사용자가 어떤 알림을 받을지 알림 설정을 상세하게 조정할 수 있도록 제공한다. 

- 전송률 제한: 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다.

- 푸시 알림과 보안: iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다.

- 큐 모니터링: 알림 시스템을 모니터링 할 떄 중요한 메트링 하나는 큐에 쌓인 알림의 개수이다. 이 수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리하고 있지 못하다는 것이다. 그런 경우 작업 서버를 증설하는 것을 고려해볼 수 있다.

- 이벤트 추적: 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다. analytics는 보통 이벤트 추적 기능도 제공한다. 

### 수정된 설계안
![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252Fe37b49bd-d2d3-4a5a-a0ce-1cdecf1d31ac%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-14.png%3Ftable%3Dblock%26id%3D256044e2-d19e-4329-9cfa-4b20819ce551%26cache%3Dv2&w=2048&q=75)

- 알림 서버에 인증과 전송률 제한 기능이 추가되었다.
- 전송 실패에 대응하기 위한 재시도 기능이 추가되었다. 전송에 실패한 알림은 다시 큐에 넣고 지정된 횟수만큼 재시도한다.
- 전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다.
- 모니터링과 추적 시스템을 추가하여 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 하였다.

## 4단계: 마무리
이번 장에선 아래 주제에 집중하였다.
- 안정성(reliability): 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 도입
- 보안(security): 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 등의 메커니즘을 이용
- 이벤트 추적 및 모니터링: 알림이 만들어진 후 성공적으로 전송되기까지의 과정을 추적하고 시스템 상태를 모니터링하기 위해 알림 전송의 각 단계마다 이벤트를 추적하고 모니터링할 수 있는 시스템을 통합
- 사용자 설정: 사용자가 알림 수신 설정을 조정할 수 있도록 하였음
- 전송율 제한: 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 하였음
