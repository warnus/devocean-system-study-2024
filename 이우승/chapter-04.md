
# 처리율 제한 장치의 설계

- 처리율 제한 장치(rate limiter) : 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치
- ex) 특정 기간 요청되는 HTTP 횟수 제한
- 임계치를 넘는 요청은 중단 시킴

사례
- 사용자는 초당 2회 이상 새 글을 올릴 수 없음
- 같은 IP주소로 하루 10개 이상의 계정을 생성할 수 없음

제한 장치의 이점
- DoS 공격 방지
- 비용 절감 : 서버를 불필요하게 많이 둘 필요 없음
- 서버 과부하 방지 : 봇에서 오는 트래픽이나 사용자의 잘못된 이용 패턴 예벙
	- ex) 무분별한 크롤링

DoS(Denial of Service)란?
- 장치의 정상적인 작동을 방해
- 정상적인 트래픽을 처리 할 수 없을 때까지 대상 시스템에 요청을 폭주시킴

DDoS(Distributed DoS) vs DoS
![](/이우승/assets/ch-04/ch04_01.png)

DDoS 공격 유형 참고 : https://www.cloudflare.com/ko-kr/learning/ddos/what-is-a-ddos-attack/

## 처리율 제한장치 요구사항 예시

- 설정된 처리율을 초과화는 요청은 정확하게 제한
- 낮은 응답시간: HTTP 응답시간에 나쁜 영향을 주면 안된다
- 적은 메모리 사용
- 분산형 처리율 제한: 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유
- 예외처리 : 요청이 제한되었을 때 사용자에게 분명하게 알려야함
- Fault Tolerance: 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주면 안됨

## 처리율 제한 장치는 어디에 둘까?

- 클라이언트 사이드 : 클라이언트는 쉽게 위변조 가능, 적합하지 않다.
- 서버 사이드: API 서버에 두거나 미들웨어로 만들어서 요청을 통제

APi 서버에)
![](/이우승/assets/ch-04/ch04_02.jpeg)

미들웨어로)
![](/이우승/assets/ch-04/ch04_03.jpeg)

## API Gateway
- 클라우드 서비스의 경우 처리율 제한 장치는 일반적으로 API Gateway라 불리는 컴포넌트에 구현됨
- 처리율 제한, SSL termination, 사용자 인증, IP 허용 목록 관리 등을 담당

API Gateway
- kong : https://konghq.com/products/kong-gateway
- tyk : https://tyk.io/
- krakenD : https://www.krakend.io/



처리율 제한 HTTP 헤더
postman이나 insomnia로 확인하는 거 적기

## 처리율 제한 알고리즘


### 토큰 버킷 알고리즘(Token Bucket)

- 간단하고, 보편적으로 사용됨

동작 원리
- 토큰 버킷은 지정된 용량을 갖는 컨테이너
- 사전 설정된 양의 토큰이 주기적으로 채워짐
- 꽉 찬 버킷에는 더 이상의 토큰이 추가 되지 않음
- 각 요청은 처리될 때마다 하나의 토큰 사용
- 충분한 토큰이 없으면 요청은 버려짐

토큰 버킷 알고리즘 인자
- 버킷 크기 : 버킷에 담을 수 있는 토큰의 최대 개수
- 토큰 공급률 : 초당 몇 개의 토큰이 버킷에 공급되는가

버킷 사용 개수
- 통상적으로, API endpoint마다 별도의 버킷 사용
- IP 주소별로 처리율 제한을 사용하는 경우 IP 주소마다
- 시스템 전체에 적용하려는 경우 버킷을 하나 사용하여 적용

장점
- 구현이 쉬움
- 메모리 사용 측면에서 효율적
- 짧은 시간에 집중되는 트래픽 처리 가능

단점
- 버킷 크기와 공급률 조정이 까다로움



윈도우 로깅
- 1분 내에 다른 요청이 오면 못하게 하는 걸로 잘 동작할 거 같은데..


# 참고

API Gateway
- https://velog.io/@holicme7/Kong-API-Gateway-%EA%B8%B0%ED%83%80-Gateway-%EC%86%94%EB%A3%A8%EC%85%98-%EB%B9%84%EA%B5%90