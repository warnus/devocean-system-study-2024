
# URL 단축기 설계

- Long URL 입력시 Short URL로 변환
- 변환된 URL로 접속 시 본래 URL로 redirect

## 문제 이해 및 설계 범위

- 쓰기 연산 : 매일 1억개의 단축 URL 생성
- 초당 쓰기 연산 : 1억/24/3600 = 1160
- 읽기 연산 : 읽기 연산과 쓰기 연산 비율은 10:1이라고 가정 -> 읽기 연산은 초당 11600회
- URL 단축 서비스 10년 운영 시 1억 x 365 x 10 = 3650억개 레코드 보관해야함
- 축약 전 URL의 평균 길이는 100으로 가정
- 10년 동안 필요한 저장 용량은 3650억 x 100 byte = 36.5TB

### API Endpoint

- URL 단축용
	- POST /api/v1/data/shorten
	- 인자 : {longURL : longURLstring}
	- 반환 : 단축 URL
- URL Redirection용
	- GET /api/v1/shortUrl
	- 반환 : HTTP 리디렉션 목적지가 될 원래 URL

### URL 리디렉션

- 브라우저에서 단축 URL 호출 시 아래와 같이 동작
- URL을 받은 서버는 그 URL을 원래 URL로 바꾸어 301 응답의 Location 헤더에 반환

![|600][이우승/assets/ch-08/ch08_01.jpeg]

- 301 Permanently moved : 브라우저에서 해당 응답을 캐시
	- 301 방식은 서버 부하를 줄이는 것이 중요한 경우 채택
- 302 Found : 일시적으로 Location 헤더에 URL 전달, 클라이언트 요청은 언제나 단축 URL tjqjdp qhsowla
	- 302 방식은 클릭 발생률이나 발생 위치를 추적하는 경우 유리


### URL 단축

- 단축 URL은 다음과 같은 형식
	- www.tinyurl.com/{hashValue}
- 중요한 것은 긴 URL과 단축 URL을 대응시키는 해시 함수 fx를 찾는 것

![|400][이우승/assets/ch-08/ch08_02.jpeg]

요구사항
- 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야함
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야함

### 데이터모델

- 모든 것을 해시 테이블에 두는 것은 메모리 제한 등으로 문제가 있음
- 더 나은 방법은 <단축 URL, 원래 URL> 쌍으로 DB에 저장하는 것
- 다축 URL DB Table
	- ID
	- shortURL
	- longURL

### 해시 함수

- 원래 URL을 단축 URL로 변환하는데 사용

#### 해시 값 길이

- hashValue는 [0-9, a-z, A-Z]의 문자들로 구성
- 사용할 수 있는 문제 개수는 62개
- 최초 요구 사항이었던 3650억개 이상의 URL 생성 필요시 hashValue의 길이는 7자 되어야함

## 해시 함수 구현 기술

### 해시 후 충돌 해소

- 7글자 문자열로 해시를 생성하는 쉬운 방법은 CRC32, MD5, SHA-1 등을 이용하여 7자로 자르는 방법
- 이 경우 서로 충돌 가능성이 높아짐
- 충돌이 발생하면 사전에 정한 문자열을 해시 값에 덧붙임

![|600][이우승/assets/ch-08/ch08_03.jpeg]

단점
- 충돌 시 한 번 이상 DB 조회 필요

### base-62 변환

- 진법 변환(base conversion)은 URL 단축기 구현 시 흔히 사용되는 접근법
- 62진법은 총 62개 문자(앞서 요구사항에 정의한 문자들)를 사용하는 진법
- 0은 0, 9는 9, a는 10, z는 35, Z는 61로 대응
- ID : 11157(10진법) -> 2TX로 변환됨


| 해시 후 충돌 해소 전략 | base-62 변환 |
|---------------------|-------------|
| 단축 URL의 길이가 고정됨 | 단축 URL의 길이가 가변적, ID 값이 커지면 같이 길어짐 |
| 유일성이 보장되는 ID 생성기가 필요하지 않음 | 유일성 보장 ID 생성기가 필요 |
| 충돌이 가능해서 해소 전략이 필요 | ID의 유일성이 보장된 후에야 적용 가능한 전략이라 충돌은 아예 불가능 |
| ID로부터 단축 URL을 계산하는 방식이 아니라서 다음에 쓸 수 있는 URL을 알아내는 것이 불가능 | ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안상 문제가 될 소지가 있음 |
