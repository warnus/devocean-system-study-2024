
# 분산 시스템을 위한 유일 ID 생성기 설계

- 분산 환경에서 유일성이 보장되는 ID 생성 시스템을 설계하는 것이 목표

## 문제 이해 및 설계 범위 확정

유일 ID 생성 시스템은 아래의 조건 범위를 만족시킨다

- ID는 유일해야 한다
- ID는 숫자로만 구성되어야 한다
- ID는 64비트로 표현할 수 있는 값
- ID는 발급 날짜에 따라 절렬 하능해야한다
- 초등 10000개이의 ID


## 유일 ID 생성 방법

아래와 같은 유일 ID 생성 방법에 대해 살펴볼 것

- 다중 마스터 복제(multi-master replication)
- UUID(Universally Unique Identifier)
- 티켓 서버(ticket server)
- 트위터 스노프레이크(twitter snowflake) 접근법

### 다중 마스터 복제

![|600](/이우승/assets/ch-07/ch07_01.jpeg)

- DB의 auto increment 기능을 활용하는 것
- 다음 ID 값을 구할 때 DB 개수 만큼 정해진 k값을 증가시킴
- 규모 확장 가능한 구조

단점
- 여러 데이터센터에 걸쳐 규모를 늘리기 어려움
- ID의 유일성은 보장하지만, 그 값이 시간 흐름에 맞추어 커지는 보장은 없음
- 서버를 추가하거나 삭제할 때도 잘 동작하도록 하기 어려움

### UUID

- 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트 수
- 충돌 가능성이 지극히 낮음
- 중복이 한 개 생길 확률을 50%로 만들려면 초당 10억개의 UUID를 100년 동안 계속 만들어야함
- 일반적으로 8-4-4-4-12 형식
	- ex) 123e4567-e89b-12d3-a456-426614174000

![[이우승/assets/ch-07/ch07_02.png]]

장점
- UUID를 만드는 것은 서버 사이 조율이 필요없으므로 단순하고 동기화 이슈가 없음
- 각 서버가 각자 ID를 생성해서 사용하면 되는 구조이므로 규모 확장 용이
단점
- ID가 128비트로 길다
- ID를 시간순으로 정렬 할 수 없다
	- -> UUID 구조를 보면 time base로 생성하는 버전도 있는데 이것도 마찬가지로 시간순 정렬이 안 되나?
- ID에 숫자(numeric)이 아닌 값이 포함될 수 있음


## 티켓 서버

- auto increment 기능을 갖춘 DB 서버(티켓서버)를 중앙 집중형으로 하나만 사용

![|600][이우승/assets/ch-07/ch07_03.jpg]

장점
- 유일성이 보장되는 숫자로만 구성된 ID를 쉽게 만들 수 있음
- 구현하기 쉽워 중소 규모 애플리케이션에 적합

단점
- 티켓 서버가 SPOF가 됨


### 트위터 스노플레이크(snowflask) 접근법

- 생성해야 하는 ID의 구조를 여러 절(section)으로 분할

![|600][이우승/assets/ch-07/ch07_04.jpg]

- sign bit : 음수와 양수를 구별하는데 사용할 수 있으나 일반적으로 사용 유보
- timestamp : 41 비트 할당. 기원 시각(epoch) 이후로 몇 밀리초가 경과했는지를 나타냄
	- 해당 값으로 최대 언제까지 ID 생성기를 사용 가능한지 추정 가능
- 데이터센터 ID : 5비트로 할당, 2^5=32개 데이터센터 지원
- 서버 ID : 5비트 할당, 데이터센터당 32개 서버 지원
- 일련번호 : 12비트 할당, 각 서버에서 ID를 생성할 때마다 이 일련 번호를 1증가
	- 해당 값은 1밀리초가 경과하면 0으로 리셋

### 타임스탬프

- 시간 흐름에 따라 점점 큰 값을 갖게 되므로, ID는 시간 순으로 정렬 가능
- 41비트로 표현할 수 있는 타임스탬프의 최대값은 2^41 - 1 = 2199023255551 밀리초 -> 69년 사용 가능

### 일련번호

- 일련 번호는 12비트 -> 2^12 = 4096개
- 밀리초 내에 하나 이상의 ID 생성시만 증가


## 참고

UUID
- https://docs.tosspayments.com/resources/glossary/uuid

snowflake
- https://bistros.tistory.com/185